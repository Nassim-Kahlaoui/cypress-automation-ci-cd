trigger:
  - main

# ==========================================================
#                   GLOBAL SETTINGS
# ==========================================================
variables:
  CYPRESS_CACHE_FOLDER: $(Pipeline.Workspace)/cypress-cache
  CYPRESS_RETRIES: 2
  NODE_VERSION: '20.x'

# ==========================================================
#                    STAGE 1 : BUILD
# ==========================================================
stages:
  - stage: Build
    displayName: "ðŸ”§ Build & Install"
    jobs:
      - job: BuildJob
        displayName: "Install Dependencies & Cypress"
        pool:
          vmImage: ubuntu-latest

        steps:
          - checkout: self

          # Cache Node Modules
          - task: Cache@2
            displayName: "Cache Node Modules"
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: 'npm | "$(Agent.OS)"'
              path: node_modules

          # Install Node
          - task: NodeTool@0
            displayName: "Install Node.js"
            inputs:
              versionSpec: $(NODE_VERSION)

          # Install deps + Cypress
          - script: |
              npm install
              npx cypress install
            displayName: "Install NPM Packages & Cypress"

          # Cache Cypress binary
          - task: Cache@2
            displayName: "Cache Cypress Binary"
            inputs:
              key: 'cypress | "$(Agent.OS)"'
              restoreKeys: 'cypress | "$(Agent.OS)"'
              path: $(CYPRESS_CACHE_FOLDER)

# ==========================================================
#                    STAGE 2 : TEST
# ==========================================================
  - stage: Test
    dependsOn: Build
    displayName: "ðŸ§ª Cypress Parallel Tests"
    jobs:
      - job: CypressTests
        displayName: "Run Cypress Tests (Chrome & Edge)"
        pool:
          vmImage: ubuntu-latest

        strategy:
          matrix:
            Chrome:
              BROWSER: chrome
            Edge:
              BROWSER: edge
              parallel: 2

        steps:
          - checkout: self

          - script: |
              echo "Running tests on browser: $(BROWSER)"
              npx cypress run \
                --browser $(BROWSER) \
                --reporter mochawesome \
                --env retry=$(CYPRESS_RETRIES)
            displayName: "Run Cypress with Mochawesome + Retry"

# ==========================================================
#                    STAGE 3 : REPORTS
# ==========================================================
  - stage: Reports
    dependsOn: Test
    displayName: "ðŸ“Š Generate & Publish Reports"
    jobs:
      - job: ReportsJob
        displayName: "Mochawesome Merge + Artifacts"
        pool:
          vmImage: ubuntu-latest

        steps:
          - checkout: self

          # Install merge tools
          - script: |
              npm install mochawesome-merge mochawesome-report-generator
            displayName: "Install Report Tools"

          # Merge reports
          - script: |
              npx mochawesome-merge cypress/reports/*.json > merged-output.json
              npx mochawesome-report-generator merged-output.json -o cypress/reports/html
            displayName: "Generate HTML Dashboard"

          # Publish artifacts
          - task: PublishBuildArtifacts@1
            displayName: "ðŸ“¤ Publish HTML Report"
            inputs:
              PathtoPublish: 'cypress/reports/html'
              ArtifactName: 'HTML-Report'
              publishLocation: 'Container'

          - task: PublishBuildArtifacts@1
            displayName: "ðŸ“¤ Publish Videos"
            inputs:
              PathtoPublish: 'cypress/videos'
              ArtifactName: 'Videos'
              publishLocation: 'Container'

          - task: PublishBuildArtifacts@1
            displayName: "ðŸ“¤ Publish Screenshots"
            inputs:
              PathtoPublish: 'cypress/screenshots'
              ArtifactName: 'Screenshots'
              publishLocation: 'Container'
